<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Teleoperated Robot Hand: Code/RobotHandReceiver Directory Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Teleoperated Robot Hand
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('dir_9e93b160a938d8cd5acba03dea5b7307.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">RobotHandReceiver Directory Reference</div></div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 id="header-subdirs" class="groupheader"><a id="subdirs" name="subdirs"></a>
Directories</h2></td></tr>
<tr class="memitem:src" id="r_src"><td class="memItemLeft" align="right" valign="top"><span class="iconfolder"><div class="folder-icon"></div></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_c96398a9cca97f309f875cad3fb189d5.html">src</a></td></tr>
</table>
<a name="details" id="details"></a><h2 id="header-details" class="groupheader">Detailed Description</h2>
<h1 class="doxsection"><a class="anchor" id="autotoc_md1"></a>
Robot Hand Receiver</h1>
<p>This folder contians the platform.io project for the receiver in the project. The receiver is tasked with receiving flex readings from the transmitter and moving the motors to bend the finger(s) to match the user's movements.</p>
<p><img src="https://github.com/user-attachments/assets/22ad9c68-781f-4aae-846d-7565a1a44701" alt="image" width="572" height="154" class="inline"/></p>
<p>There are 2 tasks for this project, the Receiver Task and the Controller Task. The Receiver Task is blocking waiting for the ESP-NOW callback to run meaning that data from the transmitter has arrived. The callback is made to be extermely fast and quick to ensure safe non critical behavior:</p>
<div class="fragment"><div class="line">/**</div>
<div class="line"> * @brief ESP-NOW receive callback.</div>
<div class="line"> *</div>
<div class="line"> * Copies the received packet into a FreeRTOS queue for processing</div>
<div class="line"> * by ::ReceiverTask.</div>
<div class="line"> *</div>
<div class="line"> * @param mac          MAC address of sender.</div>
<div class="line"> * @param incomingData Pointer to received data buffer.</div>
<div class="line"> * @param len          Length of received data in bytes.</div>
<div class="line">*/</div>
<div class="line">void OnDataRecv(const uint8_t * mac, const uint8_t *incomingData, int len) {  </div>
<div class="line">  Hand_Data data;</div>
<div class="line">  memcpy(&amp;data, incomingData, sizeof(data));</div>
<div class="line">  xQueueSend(packet_queue, &amp;data, 0);</div>
<div class="line"> </div>
<div class="line">  return;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Since the transmitter is unicasting specifically to the MAC address of the receiver ESP32, we do not need to worry about setting up the MAC address like we did in the receiver.</p>
<p>Once having received data the Receiver Task converts the raw flex readings into potentiometer-space targets:</p>
<div class="fragment"><div class="line">float ratio = (flex_value - F_MIN) / (F_MAX - F_MIN);</div>
<div class="line">float enc   = E_MIN + ratio * (E_MAX - E_MIN);</div>
</div><!-- fragment --><p> Each target is then sent to it's dedicated finger queue. Similar to the Transmitter Task, a <a class="el" href="class_hand.html" title="Class holding FreeRTOS queues for all glove fingers and palm.">Hand</a> class is used to house all the queues.</p>
<p>The Controller Task implements a 2 state FSM:</p>
<p><img src="https://github.com/user-attachments/assets/b91002b2-3764-4f0b-944b-b6a7779c19a5" alt="image" width="454" height="204" class="inline"/></p>
<p>Though before entering a state, the Controller reads from the encoders on each loop. There are rotary potentiometers attached to each motor that serve as encoder values. To read the current position of each motor, the potentiometers are connected to an 8 channel external ADC chip that communicates over I2C. We use the official Adafruit library for interfacing with this chip:</p>
<div class="fragment"><div class="line">/**</div>
<div class="line"> * @brief External ADC instance for rotary encoder (potentiometer) readings.</div>
<div class="line">*/</div>
<div class="line">Adafruit_ADS7830 ad7830;</div>
</div><!-- fragment --><p>In the Homing state, each funger motor is driver towards a known home position</p>
<div class="fragment"><div class="line">Hand_Data home = {20, 20, 20, 20, 20, 20};</div>
</div><!-- fragment --><p>Once all the fingers are homed the system transition to Position Control state. During position control, the task performs non blocking reads of the latest target value from the finger queues:</p>
<div class="fragment"><div class="line">if (xQueueReceive(glove.thumb_queue, &amp;val, 0) == pdTRUE)</div>
<div class="line">  targets.thumb_data = val;</div>
</div><!-- fragment --><p>For both Homing and Position Control, motor movement is calculated through a PID. Each finger/joint has its own PID that takes in the current potentiometer value and the target potentiometer value. There are 2 separate functions for running the PID in the Homing state versus the Position Control state. The Homing state only utilizes a P controller while the Position Control has a PID controller.</p>
<div class="fragment"><div class="line">void PositionControlFinger(uint32_t enc, uint32_t target, PID_t *pid, int pwm_channel, int phase_pin, float dt);</div>
<div class="line"> </div>
<div class="line">bool HomeFinger(uint32_t enc, uint32_t home_target, int pwm_channel, int phase_pin);</div>
</div><!-- fragment --><p>This distinction was made because when homing we only want to be around a certain threshold of potentiometer values to be home but we want more precise control when trying to match the user's motion.</p>
<p>The magnitude of the PID and P controller becomes the speed of the motor.</p>
<p>PID Controller:</p>
<div class="fragment"><div class="line">float error = (float)target - (float)enc;</div>
<div class="line">float u = PID_Step(pid, error, dt);  // signed</div>
<div class="line"> </div>
<div class="line">SetPhase(u, phase_pin); // Find direction to move in</div>
<div class="line"> </div>
<div class="line">float mag = fabsf(u);</div>
<div class="line">int pwm = (int)mag;</div>
</div><!-- fragment --><p>P Controller: </p><div class="fragment"><div class="line">float u = HOMING_KP * (float)err;</div>
<div class="line">SetPhase(u, phase_pin);</div>
<div class="line"> </div>
<div class="line">float mag_u = fabsf(u);</div>
<div class="line">int pwm = (int)mag_u; </div>
</div><!-- fragment --><p>while the direction comes from the sign of the output.</p>
<div class="fragment"><div class="line">/**</div>
<div class="line"> * @brief Set motor direction based on signed control effort.</div>
<div class="line"> *</div>
<div class="line"> * Uses the sign of the control signal to determine the motor</div>
<div class="line"> * rotation direction via the phase pin.</div>
<div class="line"> *</div>
<div class="line"> * @param u               Signed control output.</div>
<div class="line"> * @param motor_phase_pin GPIO pin controlling motor direction.</div>
<div class="line"> */</div>
<div class="line">void SetPhase(float u, uint32_t motor_phase_pin) {</div>
<div class="line">  digitalWrite(motor_phase_pin,(u &gt;= 0.0f) ? HIGH : LOW);</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a href="dir_23fdee2f6995db16c755697cdf620cf4.html">Code</a></li><li class="navelem"><a href="dir_9e93b160a938d8cd5acba03dea5b7307.html">RobotHandReceiver</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
